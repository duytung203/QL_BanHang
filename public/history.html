<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch s·ª≠ giao d·ªãch</title>
     <link rel="stylesheet" href="CSS/history.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="wrapper">
  <div class="header-content">
    <div class="logo" aria-label="Thanh Tra Tea">THANH TRA TEA</div>
    <div>
      <nav class="main-nav" aria-label="Main navigation">
        <ul>
          <li><a href="index.html">Trang ch·ªß</a></li>
          <li><a href="#" id="menu-coffee">Coffee</a></li>
          <li><a href="#"id="menu-tea">Tr√†</a></li>
          <li class="menuchinh" aria-haspopup="true" aria-expanded="false">
            <a href="#">Menu</a>
            <ul class="menuphu" role="menu">
              <li><a href="#" id="menu-banh">B√°nh ng·ªçt</a></li>
              <li><a href="#" id="menu-anvat">ƒê·ªì ƒÉn v·∫∑t</a></li>
            </ul>
          </li>
          <li><a href="tintuc.html">Tin t·ª©c</a></li>
          <li><a href="tuyendung.html">Tuy·ªÉn d·ª•ng</a></li>
        </ul>
      </nav>    
    </div>
  </div>

  <div class="order-history">
  <h2>L·ªãch s·ª≠ giao d·ªãch c·ªßa <span id="username-display"></span></h2>
  <table id="order-table">
    <thead>
      <tr>
        <th>M√£ ƒë∆°n</th>
        <th>Ng√†y ƒë·∫∑t</th>
        <th>Tr·∫°ng th√°i</th>
        <th>T·ªïng ti·ªÅn</th>
        <th>S·∫£n ph·∫©m</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="search-bar">
  <label>T·ª´ ng√†y:
    <input type="date" id="fromDate">
  </label>
  <label>ƒê·∫øn ng√†y:
    <input type="date" id="toDate">
  </label>
  <button onclick="searchOrders()">üîç T√¨m ki·∫øm</button>
  <button id="export-btn">üì§ Xu·∫•t b√°o c√°o</button>
  </div>
</div>
</div>  


<div id="loading-message" style="display: none; text-align: center; margin-top: 12px; color: #4caf50; font-style: italic;">
  üîÑ ƒêang t√¨m ƒë∆°n h√†ng, vui l√≤ng ch·ªù...
</div>
<h3>Giao D·ªãch Coin</h3>

<table class="table table-bordered table-striped mt-3">
  <thead class="table-dark">
    <tr>
      <th>#</th>
      <th>S·ªë coin</th>
      <th>Lo·∫°i giao d·ªãch</th>
      <th>M√¥ t·∫£</th>
      <th>M√£ voucher</th>
      <th>Tr·∫°ng th√°i</th>
      <th>Th·ªùi gian</th>
    </tr>
  </thead>
  <tbody id="historyTableBody">
    <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c JS ƒë·ªï v√†o ƒë√¢y -->
  </tbody>
</table>


<script>
  const user = JSON.parse(localStorage.getItem('user'));
    if (user && user.username) {
    document.getElementById('username-display').textContent = `- ${user.username}`;
  }

  fetch(`/api/orders/history/${user.id}`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector('#order-table tbody');
      tbody.innerHTML = ''; // clear table

      data.forEach(order => {
        const productList = order.items.map(item => 
          `<li>${item.name} x${item.quantity} - ${item.price.toLocaleString()}ƒë</li>`
        ).join('');

        const row = `
          <tr>
            <td>#${order.order_id}</td>
            <td>${new Date(order.created_at).toLocaleString()}</td>
            <td>${order.status}</td>
            <td>${order.total_price.toLocaleString()}ƒë</td>
            <td><ul>${productList}</ul></td>
          </tr>
        `;

        tbody.insertAdjacentHTML('beforeend', row);
      });
    })
    .catch(err => {
      console.error('L·ªói t·∫£i ƒë∆°n h√†ng:', err);
      document.querySelector('#order-table tbody').innerHTML =
        '<tr><td colspan="5">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>';
    });
    function searchOrders() {
  const fromDate = document.getElementById('fromDate').value;
  const toDate = document.getElementById('toDate').value;
  loadOrders(fromDate, toDate);
}
function loadOrders(fromDate = '', toDate = '') {
  const user = JSON.parse(localStorage.getItem('user'));
  const loadingEl = document.getElementById('loading-message');
  const tbody = document.querySelector('#order-table tbody');

  // Hi·ªán "ƒêang t√¨m"
  loadingEl.style.display = 'block';
  loadingEl.style.opacity = '1';
  tbody.innerHTML = ''; 

  let url = `/api/orders/history/${user.id}`;
  const params = new URLSearchParams();

  if (fromDate) params.append('fromDate', fromDate);
  if (toDate) params.append('toDate', toDate);

  if (params.toString()) {
    url += '?' + params.toString();
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">Kh√¥ng c√≥ ƒë∆°n h√†ng ph√π h·ª£p.</td></tr>`;
      } else {
        data.forEach(order => {
          const productList = order.items.map(item =>
            `<li>${item.name} x${item.quantity} - ${item.price.toLocaleString()}ƒë</li>`
          ).join('');

          const row = `
            <tr>
              <td>#${order.order_id}</td>
              <td>${new Date(order.created_at).toLocaleString()}</td>
              <td>${order.status}</td>
              <td>${order.total_price.toLocaleString()}ƒë</td>
              <td><ul>${productList}</ul></td>
            </tr>
          `;

          tbody.insertAdjacentHTML('beforeend', row);
        });
      }

      // ·∫®n hi·ªáu ·ª©ng sau khi xong
      setTimeout(() => {
        loadingEl.style.opacity = '0';
        setTimeout(() => loadingEl.style.display = 'none', 2000);
      }, 2000);
    })
    .catch(err => {
      console.error('L·ªói khi t·∫£i:', err);
      tbody.innerHTML = `<tr><td colspan="5">‚ö†Ô∏è L·ªói khi t·∫£i d·ªØ li·ªáu.</td></tr>`;
      loadingEl.style.display = 'none';
    });
}
document.getElementById('export-btn').addEventListener('click', () => {
  Swal.fire({
    title: 'Xu·∫•t b√°o c√°o?',
    text: 'B·∫°n c√≥ mu·ªën t·∫£i v·ªÅ b√°o c√°o l·ªãch s·ª≠ ƒë∆°n h√†ng kh√¥ng?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'T·∫£i v·ªÅ',
    cancelButtonText: 'Hu·ª∑',
    confirmButtonColor: '#43a047',
    cancelButtonColor: '#e57373'
  }).then((result) => {
    if (result.isConfirmed) {
      const user = JSON.parse(localStorage.getItem('user'));
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;

      let url = `/api/orders/export/${user.id}`;
      const params = new URLSearchParams();
      if (fromDate) params.append('fromDate', fromDate);
      if (toDate) params.append('toDate', toDate);
      if (params.toString()) url += '?' + params.toString();

      const link = document.createElement('a');
      link.href = url;
      link.download = 'lich_su_don_hang.xlsx';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      Swal.fire({
        icon: 'success',
        title: 'ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i b√°o c√°o!',
        showConfirmButton: false,
        timer: 1500
      });
    }
  });
});

fetch('/api/coin/history')
  .then(res => res.json())
  .then(data => {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';

    data.history.forEach((tx, index) => {
      const tr = document.createElement('tr');

      const color = tx.amount > 0 ? 'text-success' : 'text-danger';
      const sign = tx.amount > 0 ? '+' : '';

      tr.innerHTML = `
  <td>${index + 1}</td>
  <td class="${color} fw-bold">${sign}${tx.amount}</td>
  <td><span class="badge bg-secondary">${tx.type}</span></td>
  <td>${tx.description}</td>
  <td>${tx.code ? `<code>${tx.code}</code>` : ''}</td>
  <td>${tx.discount_value ? `${tx.discount_value.toLocaleString()}ƒë` : ''}</td>
  <td>${tx.expires_at ? new Date(tx.expires_at).toLocaleString() : ''}</td>
  <td>
    ${
      tx.status ? `<span class="badge ${
        tx.status === 'Ch∆∞a d√πng' ? 'bg-success' :
        tx.status === 'ƒê√£ d√πng' ? 'bg-secondary' :
        'bg-danger'
      }">${tx.status}</span>` : ''
    }
  </td>
  <td><small>${tx.created_at}</small></td>
`;

      tbody.appendChild(tr);
    });
  })
  .catch(err => {
    console.error("L·ªói load l·ªãch s·ª≠ coin:", err);
    document.getElementById('historyTableBody').innerHTML =
      `<tr><td colspan="7" class="text-center text-danger">‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ giao d·ªãch.</td></tr>`;
  });

</script>
<footer class="footer">
  <div class="footer-container">
    <div class="footer-col">
      <h3>Th√¥ng tin v·ªÅ Thanh Tra Tea</h3>
      <p>Thanh Tra Tea - Th∆∞∆°ng hi·ªáu tr√† v√† c√† ph√™ ch·∫•t l∆∞·ª£ng cao t·ª´ 2025</p>
      <div class="social-links">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-youtube"></i></a>
      </div>
    </div>

    <div class="footer-col">
      <h3>Li√™n h·ªá</h3>
      <div class="contact-item">
        <i class="fas fa-map-marker-alt"></i>
        <a href="https://maps.app.goo.gl/v5Hjq67FGXrHX6j78" target="_blank">123 ƒê∆∞·ªùng ABC, TP.H√Ä N·ªòi</a>
      </div>
      <div class="contact-item">
        <i class="fas fa-phone"></i>
        <a href="tel:0987123456">0987123456</a>
      </div>
      <div class="contact-item">
        <i class="fas fa-envelope"></i>
        <a href="mailto:thanhtratea123@gmail.com">thanhtratea123@gmail.com</a>
      </div>
    </div>

    <div class="footer-col">
      <h3>Gi·ªù m·ªü c·ª≠a</h3>
      <p>Th·ª© 2 - Th·ª© 6: 7:00 - 21:00</p>
      <p>Th·ª© 7 - CN: 8:00 - 22:00</p>
    </div>

    <div class="footer-col">
      <h3>ƒêƒÉng k√Ω nh·∫≠n tin</h3>
      <div class="newsletter">
        <input type="email" placeholder="Email c·ªßa b·∫°n">
        <button>ƒêƒÉng k√Ω</button>
      </div>
    </div>
  </div>

  <div class="footer-bottom">
    <p>&copy; 2025 Thanh Tra Tea. All Rights Reserved.</p>
  </div>
</footer>
</body>
</html>